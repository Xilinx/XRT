<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
<!-- End Google Tag Manager -->
  <title>PCIe Peer-to-Peer (P2P) &mdash; XRT Master documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Memory-to-Memory (M2M)" href="m2m.html" />
    <link rel="prev" title="Multi-Process Support" href="multiprocess.html" /> 
</head>

<body class="wy-body-for-nav">

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
<!-- End Google Tag Manager --> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="index.html" class="icon icon-home"> XRT
            <img src="_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                Master
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="platforms.html">XRT and Vitis™ Platform Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="system_requirements.html">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">Building the XRT Software Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">XRT Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Developer Build and Test Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Model and Features</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="execution-model.html">Execution Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_kernel_executions.html">XRT Controlled Kernel Execution Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiprocess.html">Multi-Process Support</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PCIe Peer-to-Peer (P2P)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bios-setup">BIOS Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#note">Note</a></li>
<li class="toctree-l3"><a class="reference internal" href="#warning">Warning</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#enable-disable-p2p">Enable/Disable P2P</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#current-p2p-configuration">Current P2P Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enable-p2p">Enable P2P</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disable-p2p">Disable P2P</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pcie-topology-considerations">PCIe Topology Considerations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#p2p-data-transfer-between-fpga-cards">P2P Data Transfer between FPGA Cards</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#opencl-coding-style">OpenCL coding style</a></li>
<li class="toctree-l3"><a class="reference internal" href="#profile-report">Profile Report</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#p2p-data-transfer-between-fpga-card-and-nvme-device">P2P Data Transfer between FPGA Card and NVMe Device</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">OpenCL coding style</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Profile Report</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="m2m.html">Memory-to-Memory (M2M)</a></li>
<li class="toctree-l1"><a class="reference internal" href="hm.html">Host Memory Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_ini.html">Configuration File xrt.ini</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User API Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="opencl_extension.html">Xilinx OpenCL extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_native_apis.html">XRT Native APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_native.main.html">XRT Native Library C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_native.main.html#id1">XRT Native Library C API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">XRT Developer's Space</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="platforms_partitions.html">Alveo™ Platform Loading Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="sysfs.html">Linux Sys FileSystem Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="formats.html">Binary Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="ert.main.html">Embedded Runtime Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="mgmt-ioctl.main.html">XCLMGMT (PCIe Management Physical Function) Driver Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="xocl_ioctl.main.html">XOCL (PCIe User Physical Function) Driver Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="zocl_ioctl.main.html">ZOCL Driver Interfaces</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools and Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="xclbintools.html">xclbinutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbutil.html">xbutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbmgmt.html">xbmgmt</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbflash2.html">xbflash2</a></li>
<li class="toctree-l1"><a class="reference internal" href="xball.html">xball</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbtop.html">xbtop</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbtools_map.html">Utility Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="nagios_plugin.html">xrt nagios plugin</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Building Platforms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="yocto.html">XRT Setup for Embedded Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Developer Build and Test Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Cloud Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mailbox.main.html">Mailbox Subdevice Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="mailbox.proto.html">Mailbox Inter-domain Communication Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud_vendor_support.html">MSD/MPD and Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="fpga_device_ready.html">FPGA device readiness within user VM</a></li>
<li class="toctree-l1"><a class="reference internal" href="vsec.html">Accessing vsec within VM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security of Alveo Platform</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python binding</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pyxrt.html">XRT Python Bindings</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug and Faqs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug-faq.html">XRT/Board Debug FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">XRT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>PCIe Peer-to-Peer (P2P)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/p2p.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <span class="target" id="p2p-rst"></span><section id="pcie-peer-to-peer-p2p">
<h1>PCIe Peer-to-Peer (P2P)<a class="headerlink" href="#pcie-peer-to-peer-p2p" title="Permalink to this headline">¶</a></h1>
<p>PCIe peer-to-peer communication (P2P) is a PCIe feature which enables two PCIe devices to directly transfer data between each other without using host RAM as a temporary storage. The latest version of Alveo PCIe platforms support P2P feature via PCIe Resizeable BAR Capability.</p>
<ol class="arabic simple">
<li><p>Data can be directly transferred between the DDR/HBM of one Alveo PCIe device and DDR/HBM of a second Alveo PCIe device.</p></li>
<li><p>A thirdparty peer device like NVMe can directly read/write data from/to DDR/HBM of Alveo PCIe device.</p></li>
</ol>
<figure class="align-center align-default" id="id3">
<img alt="_images/PCIe-P2P.svg" src="_images/PCIe-P2P.svg" /><figcaption>
<p><span class="caption-text">PCIe peer-to-peer topology and data transfer</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>To use P2P, the DDR/HBM on a Alveo PCIe platform need to be mapped to host IO memory space. The total size of DDR/HBM on most Alveo PCIe platforms is 64 GB all of which needs to mapped to the host IO memory space. Partial mapping a smaller range of device DDR is not supported in this release of XRT. Considering not all host systems (CPU/BIOS/chipset) support 64 GB IO memory space, P2P feature is off by default after a cold reboot or power cycle. The feature needs to be explicitly enabled after a cold boot.</p>
<p>Note that in addition to BIOS, host CPU should be capable of supporting a very large physical address space. Most desktop class processors do not support very large address space required for supporting 64 GB BAR together with host RAM and address space of all peripherals.</p>
<section id="bios-setup">
<h2>BIOS Setup<a class="headerlink" href="#bios-setup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Before turning on P2P, please make sure 64-bit IO is enabled and the maximium host supported IO memory space is greater than total size of DDRs on Alveo PCIe platform in host BIOS setup.</p></li>
<li><p>Enable large BAR support in BIOS. This is variously called as <em>Above 4G decoding</em>, <em>PCI 64-bit resource handing above 4G</em> or <em>Memory mapped I/O above 4GB</em> and may be found under PCIe configuration or Boot configuration.</p></li>
</ol>
<section id="note">
<h3>Note<a class="headerlink" href="#note" title="Permalink to this headline">¶</a></h3>
<p>It may be necessary to update to the latest BIOS release before enabling P2P.  Not doing so may cause the system to continuously reboot during the boot process.  If this occurs, power-cycle the system to disable P2P and allow the system to boot normally.</p>
</section>
<section id="warning">
<h3>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h3>
<p>Mother board vendors have different implementations of large PCIe BAR support in BIOS. If the host system does not support large IO memory well or if host Linux kernel does not support this feature, the host could stop responding after P2P is enabled. Please note that in some cases a warm reboot may not recover the system. Power cycle is required to recover the system in this scenario. As previosuly noted Alveo PCIe platforms turn off P2P after a power cycle.</p>
<p>Some Mother board BIOS setup allows administrator to set IO Memory base address and some do not. Having large IO Memory base could possibly cause OS kernel crash during warm reboot. Warm reboot crash has been observed on Ubuntu running with kernel 4.15 plus IO memory base been set to 56T in BIOS. To avoid this crash, setting IO memory base to 12T in BIOS is recommended. Per our test, the highest P2P BAR physical address has to be less than 32T. And not all Linux kernels have this issue.</p>
</section>
</section>
<section id="enable-disable-p2p">
<h2>Enable/Disable P2P<a class="headerlink" href="#enable-disable-p2p" title="Permalink to this headline">¶</a></h2>
<p>XRT <code class="docutils literal notranslate"><span class="pre">xbutil</span></code> is used to enable/disable P2P feature and check current configuration. P2P configuration is persistent across warm reboot. Enabling or disabling P2P requires root privilege.</p>
<p>Enabling P2P after cold boot is likly to fail because it resizes an exisitng P2P PCIe BAR to a large size and usually Linux will not reserve large IO memory for the PCIe bridges. XRT driver checks the maximum IO memory allowed by host BIOS setup and returns error if there is not enough IO memory for P2P. A warm reboot is required in this scenario after which BIOS and Linux will reassign the required expanded IO memory resource for P2P BAR.
If a system stops responding after enabling P2P and warm reboot does not recover the host then power cycle is required to recover the host.</p>
<p>Disabling P2P takes effect immediately. Currently XRT does not check if the P2P memory is in use. Administrator needs to make sure P2P is not in use before disabling it. The result of disabling P2P while it is in use is undefined.</p>
<p>The IO memory region will not be completely released after disabling P2P. Thus, re-enabling P2P does not need reboot.</p>
<section id="current-p2p-configuration">
<h3>Current P2P Configuration<a class="headerlink" href="#current-p2p-configuration" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">P2P</span> <span class="pre">Enabled</span></code> is shown within <code class="docutils literal notranslate"><span class="pre">xbutil</span> <span class="pre">examine</span></code> output as below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># xbutil examine --device 0000:03:00.1

 . . .
 P2P Status             : disabled
</pre></div>
</div>
<p>There are three possible values for <code class="docutils literal notranslate"><span class="pre">P2P</span> <span class="pre">Status</span></code> field above.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Remarks</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">enabled</span></code></p></td>
<td><p>P2P is enabled</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">disabled</span></code></p></td>
<td><p>P2P is disabled</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">iomem</span></code></p></td>
<td><p>P2P is enabled in device but system could not allocate IO
memory, warm reboot is needed</p></td>
</tr>
</tbody>
</table>
</section>
<section id="enable-p2p">
<h3>Enable P2P<a class="headerlink" href="#enable-p2p" title="Permalink to this headline">¶</a></h3>
<p>The command for enabling p2p is as below</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># sudo xbutil configure --device 0000:b3:00.1 --p2p enable
</pre></div>
</div>
<p>When trying to enable p2p, it is possible that the Pcie Bar increase cannot happen without an warm reboot. In those situation when trying to enable the P2P, you will see a message for warm reboot request. You can also verify this through <code class="docutils literal notranslate"><span class="pre">xbutil</span> <span class="pre">examine</span></code> that would show P2P status is <code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">iomem</span></code></p>
</section>
<section id="disable-p2p">
<h3>Disable P2P<a class="headerlink" href="#disable-p2p" title="Permalink to this headline">¶</a></h3>
<p>The commands for disabling p2p is as below</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># sudo xbutil configure --device 0000:b3:00.1 --p2p disable
</pre></div>
</div>
<p>Disabling and re-enabling P2P work without a warm reboot in-between.</p>
</section>
<section id="pcie-topology-considerations">
<h3>PCIe Topology Considerations<a class="headerlink" href="#pcie-topology-considerations" title="Permalink to this headline">¶</a></h3>
<p>For best performance peer devices wanting to exchange data should be under the same PCIe switch.</p>
<p>If IOMMU is enabled then all peer-to-peer transfers are routed through the root complex which will degrade performance significantly.</p>
<p>To measure peak P2P performance with two Alveo cards, it needs to use indentical configuration of both them. This means same type of Alveo and running same verson of shell. Also both card should be under the same PCIe switch. Second, it has been known that P2P read has better throughput comparing to P2P write. Thus, P2P read should be used in benchmark to get the peak performance.</p>
</section>
</section>
<section id="p2p-data-transfer-between-fpga-cards">
<h2>P2P Data Transfer between FPGA Cards<a class="headerlink" href="#p2p-data-transfer-between-fpga-cards" title="Permalink to this headline">¶</a></h2>
<section id="opencl-coding-style">
<h3>OpenCL coding style<a class="headerlink" href="#opencl-coding-style" title="Permalink to this headline">¶</a></h3>
<p>Consider the example situation as below:</p>
<blockquote>
<div><ul class="simple">
<li><p>P2P data transfer from Card1 to Card2</p></li>
<li><p>Source buffer (<cite>buf_src</cite>) is OpenCL buffer resident of Card1’s DDR</p></li>
<li><p>Destination buffer (<cite>buf_dst</cite>) is OpenCL buffer resident of Card2’s DDR</p></li>
</ul>
</div></blockquote>
<p>Typical coding style:</p>
<blockquote>
<div><ol class="arabic">
<li><p>In the OpenCL host code, create separate <cite>cl_context</cite> for each <cite>cl_device_id</cite></p></li>
<li><p>Define <cite>buf_src</cite> as regular buffer</p></li>
<li><p>Define <cite>buf_dst</cite> as P2P buffer</p></li>
<li><p>Import the P2P buffer or <cite>buf_dst</cite> to the context of <cite>buf_src</cite>. Use the following APIs</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>xclGetMemObjectFd</cite></p></li>
<li><p><cite>xclGetMemObjectFromFd</cite></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Perform the copy operation from <cite>buf_src</cite> to <cite>imported_dst_buf</cite></p></li>
</ol>
</div></blockquote>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Source Buffer (regular) in source context</span>
<span class="n">cl_mem</span><span class="w"> </span><span class="n">src_buf</span><span class="p">;</span><span class="w"></span>
<span class="n">src_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">src_context</span><span class="p">,</span><span class="w"> </span><span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span><span class="w"> </span><span class="n">buffersize</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span><span class="w"></span>
<span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel_1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src_buf</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Note: Handling of err is not shown throughout the code example. However, it is recommended</span>
<span class="c1">// to check error for most of the OpenCL APIs</span>

<span class="c1">// Destination buffer (P2P) in destination context</span>
<span class="n">cl_mem</span><span class="w"> </span><span class="n">dst_buf</span><span class="p">;</span><span class="w"></span>
<span class="n">cl_mem_ext_ptr_t</span><span class="w"> </span><span class="n">dst_buf_ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="n">dst_buf_ext</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XCL_MEM_EXT_P2P_BUFFER</span><span class="p">;</span><span class="w"></span>
<span class="n">dst_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">dst_context</span><span class="p">,</span><span class="w"> </span><span class="n">CL_MEM_READ_ONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CL_MEM_EXT_PTR_XILINX</span><span class="p">,</span><span class="w"> </span><span class="n">buffersize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dst_buf_ext</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span><span class="w"></span>
<span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel_2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dst_buf</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Import Destination P2P buffer to the source context</span>
<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xclGetMemObjectFd</span><span class="p">(</span><span class="n">dst_buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fd</span><span class="p">);</span><span class="w"></span>

<span class="n">cl_mem</span><span class="w"> </span><span class="n">imported_dst_buf</span><span class="p">;</span><span class="w"></span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xclGetMemObjectFromFd</span><span class="p">(</span><span class="n">src_context</span><span class="p">,</span><span class="w"> </span><span class="n">device_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imported_dst_buf</span><span class="p">);</span><span class="w"> </span><span class="c1">// Import</span>

<span class="c1">// Copy Operation: Local Source buffer -&gt; Imported Destination Buffer</span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clEnqueueCopyBuffer</span><span class="p">(</span><span class="n">src_command_queue</span><span class="p">,</span><span class="w"> </span><span class="n">src_buf</span><span class="p">,</span><span class="w"> </span><span class="n">imported_dst_buf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_t</span><span class="p">)</span><span class="o">*</span><span class="n">LENGTH</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="profile-report">
<h3>Profile Report<a class="headerlink" href="#profile-report" title="Permalink to this headline">¶</a></h3>
<p>In the Profile Summary report file the P2P transfer is shown under <strong>Data Transfer: DMA Bypass</strong></p>
<p><strong>Data Transfer: DMA Bypass</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 18%" />
<col style="width: 12%" />
<col style="width: 13%" />
<col style="width: 12%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Device</p></th>
<th class="head"><p>Transfer Type</p></th>
<th class="head"><p>Number of
Transfer</p></th>
<th class="head"><p>Transfer
Rate(MB/s)</p></th>
<th class="head"><p>Total Data
Transfer</p></th>
<th class="head"><p>Total
Time (ms)</p></th>
<th class="head"><p>Average
Size (Kb)</p></th>
<th class="head"><p>Average
Latency(ns)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>…</p></td>
<td><p>IN</p></td>
<td><p>4096</p></td>
<td><p>N/A</p></td>
<td><p>0.262</p></td>
<td><p>N/A</p></td>
<td><p>0.064</p></td>
<td><p>N/A</p></td>
</tr>
</tbody>
</table>
<p>The report shows the P2P transfer corresponding to the receiving device (i.e. transfer type IN).</p>
</section>
</section>
<section id="p2p-data-transfer-between-fpga-card-and-nvme-device">
<h2>P2P Data Transfer between FPGA Card and NVMe Device<a class="headerlink" href="#p2p-data-transfer-between-fpga-card-and-nvme-device" title="Permalink to this headline">¶</a></h2>
<p>Using the P2P enabled device the data can be transferred between the FPGA device and another NVMe Device, such as SMART SSD, without migrating the data via host memory space.</p>
<section id="id1">
<h3>OpenCL coding style<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Typical coding style</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Create P2P buffer</p></li>
<li><p>Map P2P buffer to the host space</p></li>
<li><p>Access the SSD location through Linux File System, the file needs to be opened with <cite>O_DIRECT</cite>.</p></li>
<li><p>Read/Write through Linux <cite>pread</cite>/<cite>pwrite</cite> function</p></li>
</ol>
</div></blockquote>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Creating P2P buffer</span>
<span class="n">cl_mem_ext_ptr_t</span><span class="w"> </span><span class="n">p2pBOExt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="n">p2pBOExt</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XCL_MEM_EXT_P2P_BUFFER</span><span class="p">;</span><span class="w"></span>

<span class="n">p2pBO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">CL_MEM_READ_ONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CL_MEM_EXT_PTR_XILINX</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p2pBOExt</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span><span class="w"> </span><span class="n">p2pBO</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Map P2P Buffer into the host space</span>

<span class="n">p2pPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">clEnqueueMapBuffer</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span><span class="w"> </span><span class="n">p2pBO</span><span class="p">,</span><span class="w"> </span><span class="n">CL_TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">CL_MAP_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CL_MAP_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">full</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">SSD</span><span class="o">&gt;</span><span class="w"></span>
<span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_DIRECT</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Read chunk_size bytes starting at offset 0 from fd into p2pPtr</span>
<span class="n">pread</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">p2pPtr</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Wrtie chunk_size bytes starting at offset 0 from p2pPtr into fd</span>
<span class="n">pwrite</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">p2pPtr</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Profile Report<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Sample Profile report from FPGA to NVMe Device transfer via P2P</p>
<p><strong>Data Transfer: DMA Bypass</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 18%" />
<col style="width: 11%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Device</p></th>
<th class="head"><p>Transfer Type</p></th>
<th class="head"><p>Number of
Transfer</p></th>
<th class="head"><p>Transfer
Rate(MB/s)</p></th>
<th class="head"><p>Total Data
Transfer</p></th>
<th class="head"><p>Total
Time (ms)</p></th>
<th class="head"><p>Average
Size (Kb)</p></th>
<th class="head"><p>Average
Latency(ns)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>…</p></td>
<td><p>OUT</p></td>
<td><p>8388608</p></td>
<td><p>N/A</p></td>
<td><p>1073.740</p></td>
<td><p>N/A</p></td>
<td><p>0.128</p></td>
<td><p>297.141</p></td>
</tr>
</tbody>
</table>
<p>Sample Profile report from NVMe Device to FPGA transfer via P2P</p>
<p><strong>Data Transfer: DMA Bypass</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 18%" />
<col style="width: 11%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Device</p></th>
<th class="head"><p>Transfer Type</p></th>
<th class="head"><p>Number of
Transfer</p></th>
<th class="head"><p>Transfer
Rate(MB/s)</p></th>
<th class="head"><p>Total Data
Transfer</p></th>
<th class="head"><p>Total
Time (ms)</p></th>
<th class="head"><p>Average
Size (Kb)</p></th>
<th class="head"><p>Average
Latency(ns)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>…</p></td>
<td><p>IN</p></td>
<td><p>4194304</p></td>
<td><p>N/A</p></td>
<td><p>1073.740</p></td>
<td><p>N/A</p></td>
<td><p>0.256</p></td>
<td><p>237.344</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="multiprocess.html" class="btn btn-neutral float-left" title="Multi-Process Support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="m2m.html" class="btn btn-neutral float-right" title="Memory-to-Memory (M2M)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2023, Advanced Micro Devices, Inc.
      <span class="lastupdated">Last updated on October 7, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>
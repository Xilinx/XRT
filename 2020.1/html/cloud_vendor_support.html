

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MSD/MPD and Plugins &mdash; XRT 2020.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Security of Alveo Platform" href="security.html" />
    <link rel="prev" title="Mailbox Inter-domain Communication Protocol" href="mailbox.proto.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> XRT
          

          
          </a>

          
            
            
              <div class="version">
                2020.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="platforms.html">Platform Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="system_requirements.html">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">Building and Installing Software Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Developer Build and Test Instructions</a></li>
</ul>
<p class="caption"><span class="caption-text">Use Model and Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="execution-model.html">Execution Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_kernel_executions.html">Supported Kernel Execution Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiprocess.html">Multi-Process Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="p2p.html">PCIe Peer-to-Peer (P2P) Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="m2m.html">Memory-to-Memory (M2M) Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="streaming_data_support.html">XRT Streaming Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt_ini.html">Configuration File xrt.ini</a></li>
</ul>
<p class="caption"><span class="caption-text">Video Acceleration Using XMA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="xma_user_guide.html">Xilinx Media Accelerator (XMA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="xma_19.2.html">XMA 19.2 Migration</a></li>
</ul>
<p class="caption"><span class="caption-text">User API Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="xrt.main.html">XRT Core Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="ert.main.html">Embedded Runtime Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="xma.main.html">XMA Core Library</a></li>
</ul>
<p class="caption"><span class="caption-text">XRT Developer's Space</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="sysfs.html">Linux Sys FileSystem Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="formats.html">Binary Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="mgmt-ioctl.main.html">XCLMGMT (PCIe Management Physical Function) Driver Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="xocl_ioctl.main.html">XOCL (PCIe User Physical Function) Driver Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="zocl_ioctl.main.html">ZOCL Driver Interfaces</a></li>
</ul>
<p class="caption"><span class="caption-text">Tools and Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="xclbintools.html">xclbinutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbutil.html">xbutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="xbmgmt.html">xbmgmt</a></li>
</ul>
<p class="caption"><span class="caption-text">Building Platforms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="yocto.html">Yocto Recipes For Embedded Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Developer Build and Test Instructions</a></li>
</ul>
<p class="caption"><span class="caption-text">Cloud Support</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="mailbox.main.html">Mailbox Subdevice Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="mailbox.proto.html">Mailbox Inter-domain Communication Protocol</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MSD/MPD and Plugins</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mailbox-message-service-daemon-msd-and-message-proxy-daemon-mpd">Mailbox, Message Service Daemon(MSD) and Message Proxy Daemon(MPD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enhancement-to-mpd">Enhancement to MPD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-mpd-plugin">Example MPD plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Security</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security of Alveo Platform</a></li>
</ul>
<p class="caption"><span class="caption-text">Debug and Faqs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug-faq.html">XRT/Board Debug FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">XRT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>MSD/MPD and Plugins</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/cloud_vendor_support.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="msd-mpd-and-plugins">
<span id="cloud-vendor-support-rst"></span><h1>MSD/MPD and Plugins<a class="headerlink" href="#msd-mpd-and-plugins" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>When FPGAs are deployed at cloud vendors, either VM based (IaaS) or container based (PaaS), there are
some common concerns need to be addressed.</p>
<ol class="arabic">
<li><p class="first">MGMT PF and USER PF of the FPGA are separated</p>
<p>Cloud vendors own the MGMT PF, while users own the USER PF. Any operations by the user on USER PF
should not damage or compromise the operation of MGMT PF.</p>
</li>
<li><p class="first">xclbin files needs to be protected</p>
<p>Some of the xclbin files are provided by third-party ISVs – they don’t want the users access their
xclbin files, but use them indirectly. That is, the xclbin files in user VM or container are not the
real ones that are running on the cards. Instead, they are fake one with the BITSTREAM section stripped.
xclbin download on the fake xclbin files in VM should result in the real one being programed without any
user perceiving</p>
</li>
<li><p class="first">Cloud vendors have more control on the xclbin download process</p>
<p>Download xclbin involves the talking between VMs or containers and the hosts. Cloud vendors have their
own ways they trust to do this.</p>
</li>
</ol>
<p>XRT addresses all of these concerns</p>
</div>
<div class="section" id="mailbox-message-service-daemon-msd-and-message-proxy-daemon-mpd">
<h2>Mailbox, Message Service Daemon(MSD) and Message Proxy Daemon(MPD)<a class="headerlink" href="#mailbox-message-service-daemon-msd-and-message-proxy-daemon-mpd" title="Permalink to this headline">¶</a></h2>
<p>The following picture illustrates how a xclbin file is downloaded on baremetal machine</p>
<div align="center" class="align-center"><img alt="_images/mailbox-msd-mpd-architecture.svg" src="_images/mailbox-msd-mpd-architecture.svg" /></div>
<p>As shown by the red arrows in the picture, the flow of the download in this case is as following:</p>
<ol class="arabic simple">
<li>User requests xclbin download from ‘xbutil program’ cmdline or OpenCL API</li>
<li>Shim layer issues ioctl to xocl driver</li>
<li>Xocl driver subdev icap sends the req to subdev mailbox (the xclbin file is in host memory, the req  size is very small)</li>
<li>Mailbox transfers the req to the peer in xclmgmt through hw mailbox</li>
<li>Xclmgmt driver subdev mailbox forwards the req to the  subdev icap</li>
<li>Xclmgmt driver subdev icap receives the req, gets xclbin file from memory, and programs the icap</li>
<li>Response is sent back to the user following the reverse way</li>
</ol>
<p><strong>Note:</strong> <em>This model also works for containers running on top of baremetal if no special requirement, ie, xclbin protection,
is needed</em></p>
<p>XRT has its xclmgmt and xocl driver separated. Mailbox is communication channel between the 2 drivers, with
which the user can do some management works with USER PF in VM, ie. download xclbin. However, HW mailbox by
design has very low bandwidth, and that makes transfer of a hundred Mega Byte xclbin file very slow. SW mailbox
is the complementary to the mailbox framework to overcome this, and it also helps as well for cases where there
are no working HW mailbox</p>
<p>SW mailbox relies on MSD/MPD. MSD resides in userspace of the machine(ie. Host) where xclmgmt driver is installed,
while MPD resides in userspace of the machine(ie. VM) where xocl driver is installed. They talk to the mailbox subdev
in the corresponding driver. MSD/MPD may be connected through external networking, eg. Ethernet, and make the download
xclbin faster</p>
<p><strong>Note:</strong> <em>In order to use SW mailbox, the cloud vendor has to setup the networking connection between Host and VM.
And this model provides a faster xclbin download, but doesn’t provide xclbin protection</em></p>
<p>Once the networking connection is setup, the following configurations are also required</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># In host, make sure the IP address configured is the one VM talks to</span>
Host&gt;$ sudo xbmgmt config --show

<span class="c1"># If the IP address is not correct, change it by running</span>
Host&gt;$ sudo xbmgmt config --daemon --host &lt;host-or-ip&gt;

<span class="c1"># Start MSD in host</span>
Host&gt;$ sudo systemctl start msd

<span class="c1"># Start MPD in VM</span>
VM&gt;$ sudo systemctl start mpd
</pre></div>
</div>
<p>The flow of downloading xclbin through SW mailbox and MSD/MPD is illustrated as below:</p>
<div align="center" class="align-center"><img alt="_images/sw-mailbox-msd-mpd-download.svg" src="_images/sw-mailbox-msd-mpd-download.svg" /></div>
<p>As shown by the green arrows in the picture, the flow of the download in this case is as following:</p>
<ol class="arabic simple">
<li>User requests xclbin download from ‘xbutil program’ cmdline or OpenCL API</li>
<li>Shim layer issues ioctl to xocl driver</li>
<li>Xocl driver subdev icap sends the req to subdev mailbox</li>
<li>Mailbox transfers the req  and xclbin file to MPD as mailbox message</li>
<li>MPD forwards the mailbox message to MSD</li>
<li>MSD transfers the mailbox message to xclmgmt driver subdev mailbox</li>
<li>Xclmgmt driver subdev mailbox forwards the req to the  subdev icap</li>
<li>Xclmgmt driver subdev icap receives the req, and programs the icap</li>
<li>Response is sent back to the user following the reverse way</li>
</ol>
<p>The mailbox(HW&amp;SW) and MSD/MPD framework perfectly addresses the 1st concern mentioned above</p>
</div>
<div class="section" id="enhancement-to-mpd">
<h2>Enhancement to MPD<a class="headerlink" href="#enhancement-to-mpd" title="Permalink to this headline">¶</a></h2>
<p>MSD/MPD are mailbox message centric. They focus on the delivering of the mailbox message and don’t interpret them.
In order to protect the xclbin file, in which case users feed fake xclbin files to xocl then plugins get real ones
and re-feed to xclmgmt, MSD/MPD have to interpret and understand the download xclbin message. An enhancement to MPD
interprets the mailbox message and calls into vendor specific plugin to download the xclbin</p>
<p>The input to the plugin is the xclbin file fed by the user in VM or container – it may be a fake xclbin file. The
plugin calls cloud vendor specific APIs to do the real download. It is the cloud vendor responsibility to,</p>
<ol class="arabic simple">
<li>Save the real xclbin files in a dedicated database</li>
<li>Retrieve the real xclbin from fake one</li>
<li>Ascertain the legality of the download itself</li>
<li>Talk to the MGMT PF (xclmgmt driver) to download the real xclbin</li>
</ol>
<p><strong>Note:</strong> <em>In this model, the cloud vendor APIs don’t know anything about mailbox. They talk to ICAP through ioctl directly. So
MSD is not being used</em></p>
<p>The flow of downloading protected xclbin through plugin is illustrated as below:</p>
<div align="center" class="align-center"><img alt="_images/sw-mailbox-mpd-plugin-download.svg" src="_images/sw-mailbox-mpd-plugin-download.svg" /></div>
<p>The vendor private part shown in the picture needs to,</p>
<ol class="arabic simple">
<li>Provide database to save real xclbin files</li>
<li>Provide download API to MPD plugin</li>
<li><dl class="first docutils">
<dt>Check the legality of the download</dt>
<dd><ol class="first last lowerroman">
<li>whether the user is authorized</li>
<li>whether the xclbin is valid</li>
<li>whether the FPGA owned by the user</li>
<li>etc</li>
</ol>
</dd>
</dl>
</li>
<li>Retrieve the real xclbin</li>
<li>Download the retrieved xclbin</li>
</ol>
<p>The enhancement to the MPD and the plugin address the 2nd and 3rd concerns mentioned above</p>
</div>
<div class="section" id="example-mpd-plugin">
<h2>Example MPD plugin<a class="headerlink" href="#example-mpd-plugin" title="Permalink to this headline">¶</a></h2>
<p>The example plugin aims at containers running on top of baremetal machines. In this case, both MGMT PF and USER PF are in the same
domain, so plugin can call ioctl on xclmgmt directly to program ICAP after it retrieves the real xclbin. This is the use case
for Nimbix</p>
<p>The plugin is built as shared object – libcontainer_mpd_plugin.so, and when users install the container pkg, the ‘so’ file
will be installed at /opt/xilinx/xrt/lib, and a soft link file – libmpd_plugin.so is created under the same folder
linking to the plugin shared object. MPD tries to dlopen(3) the shared object when it gets started</p>
<p>This delivered container plugin by default just uses the input xclbin file as output(that means no xclbin protection),
show-casing how this plugin is going to be implemented. It does have example code how to save real xclbin, how to retrieve
real xclbin from fake one, and how to download a protected xclbin, as user’s reference</p>
<p>This plugin can also be used for internal test on the MPD and mailbox</p>
<p>Example how a ubuntu host of containers configures the plugin</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># install xrt pkg</span>
$ sudo apt install /opt/xrt_201920.2.3.0_18.04-xrt.deb

<span class="c1"># install xrt pkg</span>
$ sudo apt install /opt/xrt_201920.2.3.0_18.04-container.deb

<span class="c1"># config mailbox channel switch</span>
<span class="c1"># this has to be manually configurated to ensure download xclbin going through SW mailbox</span>
$ sudo <span class="nb">echo</span> 0x100 &gt; /sys/bus/pci/devices/0000<span class="se">\:</span><span class="m">65</span><span class="se">\:</span><span class="m">00</span>.0/config_mailbox_channel_switch

<span class="c1"># When cloud vendor (eg. Nimbix) wants to enable its own xclbin protection mechanism, this</span>
<span class="c1"># plugin needs to be rebuilt and the built &#39;so&#39; needs to be copied to /opt/xilinx/xrt/lib</span>
<span class="c1"># eg</span>
$ sudo cp libcontainer_mpd_plugin.so /opt/xilinx/xrt/lib
$ sudo systemctl restart mpd
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>With the MSD/MPD framework and MPD enhancement,</p>
<ol class="arabic simple">
<li>Same XRT pkg is installed everywhere, baremetal/IaaS/PaaS/etc. Vendors only need to create/install their
specific plugins</li>
<li>Users have same Xilinx® FPGA using experience everywhere – they don’t even know whether they are running
within baremetal, VM, or containers, they don’t know whether the xclbin files they see are real one, fake
one or any other kind either</li>
</ol>
<p>The following picture illustrates how XRT is being deployed in different scenarios at cloud vendors</p>
<div align="center" class="align-center"><img alt="_images/xrt-deployment-cloud.svg" src="_images/xrt-deployment-cloud.svg" /></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="security.html" class="btn btn-neutral float-right" title="Security of Alveo Platform" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mailbox.proto.html" class="btn btn-neutral float-left" title="Mailbox Inter-domain Communication Protocol" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, Xilinx, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
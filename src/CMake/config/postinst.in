#!/bin/sh

if [ -n "`dkms status -m xrt -v @XRT_VERSION_STRING@`" ]; then
    echo "Unloading old XRT Linux kernel modules"
    modprobe -r xocl
    modprobe -r xclmgmt

    echo "Unregistering old XRT Linux kernel module sources @XRT_VERSION_STRING@ from dkms"
    res=$(dkms remove -m xrt -v @XRT_VERSION_STRING@ --all)
    if [ $? -ne 0 ]; then
        echo "Error: dkms: $res"
    fi
    find /lib/modules -type f -name xocl.ko -delete
    find /lib/modules -type f -name xclmgmt.ko -delete
    find /lib/modules -type f -name xocl.ko.kz -delete
    find /lib/modules -type f -name xclmgmt.ko.kz -delete
    find /lib/modules -type f -name xocl.ko.xz -delete
    find /lib/modules -type f -name xclmgmt.ko.xz -delete
    res=$(depmod -A)
    if [ $? -ne 0 ]; then
        echo "Error: depmod: $res"
    fi
fi

DRACUT_CONF_PATH=/etc/dracut.conf.d
if [ -e $DRACUT_CONF_PATH ]; then
    install -m 644 /usr/src/xrt-@XRT_VERSION_STRING@/driver/xclng/drm/xocl/userpf/xocl.dracut.conf $DRACUT_CONF_PATH
    install -m 644 /usr/src/xrt-@XRT_VERSION_STRING@/driver/xclng/drm/xocl/mgmtpf/xclmgmt.dracut.conf $DRACUT_CONF_PATH
fi

echo "Invoking DKMS common.postinst for xrt"
if [ -f /etc/lsb-release ]; then
    /usr/lib/dkms/common.postinst xrt @XRT_VERSION_STRING@ "" "" $2
else
    res=$("( /usr/lib/dkms/common.postinst xrt @XRT_VERSION_STRING@ "" "" $2 )" 2>&1 )
fi
if [ $? -ne 0 ]; then
    if [ -e res ]; then
        echo "Error: common.postinst: $res"
    fi
else
    echo "Finished DKMS common.postinst"
    install -m 644 /usr/src/xrt-@XRT_VERSION_STRING@/driver/xclng/drm/xocl/userpf/10-xocl.rules /etc/udev/rules.d
    install -m 644 /usr/src/xrt-@XRT_VERSION_STRING@/driver/xclng/drm/xocl/mgmtpf/10-xclmgmt.rules /etc/udev/rules.d

    echo "Loading new XRT Linux kernel modules"
    udevadm control --reload-rules
    modprobe xclmgmt
    modprobe xocl
    udevadm trigger
fi


if [ -z "`dkms status -m xrt -v @XRT_VERSION_STRING@ |grep installed`" ]; then
    echo "****************************************************************"
    echo "* DKMS failed to install XRT drivers."
    echo "* Please check if kernel development headers are installed for OS variant used."
    echo "* "
    echo "* Check build logs in /var/lib/dkms/xrt/@XRT_VERSION_STRING@"
    echo "****************************************************************"
fi

exit 0

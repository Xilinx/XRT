#!/bin/sh

if [ -n "`dkms status -m xrt -v @XRT_VERSION_STRING@`" ]; then
   echo "Unregistering old XRT Linux kernel module sources @XRT_VERSION_STRING@ from dkms"
   dkms remove -m xrt -v @XRT_VERSION_STRING@ --all
   find /lib/modules -type f -name xocl.ko -delete
   find /lib/modules -type f -name xclmgmt.ko -delete
   find /lib/modules -type f -name xocl.ko.kz -delete
   find /lib/modules -type f -name xclmgmt.ko.kz -delete
   depmod -A
fi

if [ -z "`dkms status -m xrt -v @XRT_VERSION_STRING@`" ]; then
    echo "Registering new XRT Linux kernel module sources @XRT_VERSION_STRING@ with dkms"
    dkms add -m xrt -v "@XRT_VERSION_STRING@"
fi

if [ -e /lib/modules/`uname -r`/build/include ]; then
    echo "Building XRT Linux kernel modules sources with dkms"
    dkms build -m xrt -v "@XRT_VERSION_STRING@"
    echo "Installing XRT Linux kernel modules sources with dkms"
    dkms install -m xrt -v "@XRT_VERSION_STRING@" --force
    install -m 644 /usr/src/xrt-@XRT_VERSION_STRING@/driver/xclng/drm/xocl/userpf/10-xocl.rules /etc/udev/rules.d
    install -m 644 /usr/src/xrt-@XRT_VERSION_STRING@/driver/xclng/drm/xocl/mgmtpf/10-xclmgmt.rules /etc/udev/rules.d
else
    echo "Build/Install of XRT Linux kernel modules skipped since Linux kernel headers are not installed"
fi

exit 0

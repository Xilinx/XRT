#!/bin/sh

lsb_release -si | grep -Eq "^RedHat|^CentOS"
if [ $? -eq 0 ] && [ $1 -ge 1 ]; then
    echo "Cleanup is skipped for package upgrade"
    exit 0
fi

lsb_release -si | grep -Eq "^Ubuntu"
if [ $? -eq 0 ] && [ "$1" = "upgrade" ]; then
    echo "Cleanup is skipped for package upgrade"
    exit 0
fi

# Stop and remove all daemons
echo "Removing MSD / MPD daemons"
systemctl stop msd > /dev/null 2>&1
systemctl disable msd > /dev/null 2>&1
systemctl stop mpd > /dev/null 2>&1
systemctl disable mpd > /dev/null 2>&1
rm -rf /etc/systemd/system/msd.service
rm -rf /etc/systemd/system/mpd.service
systemctl daemon-reload
# Remove config file for MSD as well
/opt/xilinx/xrt/bin/xbmgmt config --purge 2>&1 > /dev/null

echo "Unloading old XRT Linux kernel modules"
modprobe -r xocl
modprobe -r xclmgmt

echo "Unregistering XRT Linux kernel module sources @XRT_VERSION_STRING@ from dkms"
dkms remove -m xrt -v @XRT_VERSION_STRING@ --all
find /lib/modules -type f -name xocl.ko -delete
find /lib/modules -type f -name xclmgmt.ko -delete
find /lib/modules -type f -name xocl.ko.kz -delete
find /lib/modules -type f -name xclmgmt.ko.kz -delete
find /lib/modules -type f -name xocl.ko.xz -delete
find /lib/modules -type f -name xclmgmt.ko.xz -delete
depmod -A

rm -f /etc/udev/rules.d/10-xocl.rules
rm -f /etc/udev/rules.d/10-xclmgmt.rules
rm -f /etc/dracut.conf.d/xocl.dracut.conf
rm -f /etc/dracut.conf.d/xclmgmt.dracut.conf

echo "Cleaning up XMA..."
rm -f /tmp/xma_shm_db

exit 0

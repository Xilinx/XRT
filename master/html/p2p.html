

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PCIe Peer-to-Peer Support &mdash; Xilinx Runtime 2019.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Xilinx Runtime 2019.1 documentation" href="index.html"/>
        <link rel="next" title="Memory-to-Memory (M2M) Support" href="m2m.html"/>
        <link rel="prev" title="Create MPSoC Based Embedded Platforms" href="create_platforms.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Xilinx Runtime
          

          
          </a>

          
            
            
              <div class="version">
                2019.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="platforms.html">Platform Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="execution-model.html">Execution Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="xrt.main.html">Xilinx Runtime (XRT) Core Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="mgmt-ioctl.main.html">XCLMGMT (PCIe Management Physical Function) Driver Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="xocl_ioctl.main.html">XOCL (PCIe User Physical Function) Driver Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="sysfs.html">Linux Sys FileSystem Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Board Tools and Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="xclbintools.html">Xclbin Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="ert.main.html">Embedded Runtime Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiprocess.html">Multi-Process Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="formats.html">Binary Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="system_requirements.html">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">Building and Installing Software Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="yocto.html">Yocto Recipes For Embedded Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">XRT Developer Build and Test Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="newdsa-bringup.html">New DSA Bringup</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_platforms.html">Create MPSoC Based Embedded Platforms</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PCIe Peer-to-Peer Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bios-setup">BIOS Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#warning">Warning</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#enable-disable-p2p">Enable/Disable P2P</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#current-p2p-configuration">Current P2P Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enable-p2p">Enable P2P</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disable-p2p">Disable P2P</a></li>
<li class="toctree-l3"><a class="reference internal" href="#force-enable-disable">Force Enable/Disable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pcie-topology-considerations">PCIe Topology Considerations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="m2m.html">Memory-to-Memory (M2M) Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug-faq.html">XRT/Board Debug FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="xma.main.html">Xilinx Media Accelerator (XMA) Core Library</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Xilinx Runtime</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>PCIe Peer-to-Peer Support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p2p.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pcie-peer-to-peer-support">
<h1>PCIe Peer-to-Peer Support<a class="headerlink" href="#pcie-peer-to-peer-support" title="Permalink to this headline">¶</a></h1>
<p>PCIe peer-to-peer communication (P2P) is a PCIe feature which enables two PCIe devices to directly transfer data between each other without using host RAM as a temporary storage. The latest version of SDx PCIe platforms support P2P feature via PCIe Resizeable BAR Capability.</p>
<ol class="arabic simple">
<li>Data can be directly transferred between the DDR of one SDx PCIe device and DDR of a second SDx PCIe device.</li>
<li>A thirdparty peer device like NVMe can directly read/write data from/to DDR of SDX PCIe device.</li>
</ol>
<p>To use P2P, the DDRs on a SDx PCIe platform need to be mapped to host IO memory space. The total size of DDR on most SDx PCIe platforms is 64 GB all of which needs to mapped to the host IO memory space. Partial mapping a smaller range of device DDR is not supported in this release of XRT. Considering not all host systems (CPU/BIOS/chipset) support 64 GB IO memory space, P2P feature is off by default after a cold reboot or power cycle. The feature needs to be explicitly enabled after a cold boot.</p>
<p>Note that in addition to BIOS, host CPU should be capable of supporting a very large physical address space. Most desktop class processors do not support very large address space required for supporting 64 GB BAR together with host RAM and address space of all peripherals.</p>
<div class="section" id="bios-setup">
<h2>BIOS Setup<a class="headerlink" href="#bios-setup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Before turning on P2P, please make sure 64-bit IO is enabled and the maximium host supported IO memory space is greater than total size of DDRs on SDx PCIe platform in host BIOS setup.</li>
<li>Enable large BAR support in BIOS. This is sometimes called “Above 4G decoding” and may be found under PCIe configuration or Boot configuration.</li>
</ol>
<div class="section" id="warning">
<h3>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h3>
<p>Mother board vendors have different implementations of large PCIe BAR support in BIOS. If the host system does not support large IO memory well or if host Linux kernel does not support this feature, the host could stop responding after P2P is enabled. Please note that in some cases a warm reboot may not recover the system. Power cycle is required to recover the system in this scenario. As previosuly noted SDx PCIe platforms turn off P2P after a power cycle.</p>
<p>Some Mother board BIOS setup allows administrator to set IO Memory base address and some do not. Having high or low IO Memory base could possibly cause memory address collision between P2P memory and host RAM. For example setting IO memory base set to 56T in BIOS will cause Linux to crash after a warm reboot. This is because mapped virtual address of P2P PCIe BAR collides with virtual address of other subsystems in Linux. Recent versions of Linux (4.19+) dont have this issue as they detect this during P2P BAR mapping stage itself and refuse to map the BAR. Setting IO memory base to 1T in BIOS is recommended.</p>
</div>
</div>
<div class="section" id="enable-disable-p2p">
<h2>Enable/Disable P2P<a class="headerlink" href="#enable-disable-p2p" title="Permalink to this headline">¶</a></h2>
<p>XRT <code class="docutils literal"><span class="pre">xbutil</span></code> is used to enable/disable P2P feature and check current configuration. P2P configuration is persistent across warm reboot. Enabling or disabling P2P requires root privilege.</p>
<p>Enabling P2P after cold boot is likly to fail because it resizes an exisitng P2P PCIe BAR to a large size and usually Linux will not reserve large IO memory for the PCIe bridges. XRT driver checks the maximum IO memory allowed by host BIOS setup and returns error if there is not enough IO memory for P2P. A warm reboot is required in this scenario after which BIOS and Linux will reassign the required expanded IO memory resource for P2P BAR.
If a system stops responding after enabling P2P and warm reboot does not recover the host then power cycle is required to recover the host.</p>
<p>Disabling P2P takes effect immediately. Currently XRT does not check if the P2P memory is in use. Administrator needs to make sure P2P is not in use before disabling it. The result of disabling P2P while it is in use is undefined.</p>
<p>The IO memory region will not be completely released after disabling P2P. Thus, re-enabling P2P does not need reboot.</p>
<div class="section" id="current-p2p-configuration">
<h3>Current P2P Configuration<a class="headerlink" href="#current-p2p-configuration" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">P2P</span> <span class="pre">Enabled</span></code> is shown within <code class="docutils literal"><span class="pre">xbutil</span> <span class="pre">query</span></code> output.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># xbutil query
DSA                             FPGA                        IDCode
xilinx_vcu1525_dynamic_6_0      xcvu9p-fsgd2104-2L-e        0x14b31093
Vendor          Device          SubDevice       SubVendor
0x10ee          0x6a9f          0x4360          0x10ee
DDR size        DDR count       Clock0          Clock1
34359738368     2               300             500
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            false
</pre></div>
</div>
<p>There are three possible values for <code class="docutils literal"><span class="pre">P2P</span> <span class="pre">Enabled</span></code> field above.</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Value</th>
<th class="head">Remarks</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">True</span></code></td>
<td>P2P is enabled</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">False</span></code></td>
<td>P2P is disabled</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">no</span> <span class="pre">iomem</span></code></td>
<td>P2P is enabled in device but system could not allocate IO
memory, warm reboot is needed</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="enable-p2p">
<h3>Enable P2P<a class="headerlink" href="#enable-p2p" title="Permalink to this headline">¶</a></h3>
<p>Enable P2P after power up sequence.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># xbutil p2p --enable
ERROR: resoure busy, please try warm reboot
# xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            no iomem
# reboot
...
# xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            true
...
</pre></div>
</div>
<p>Enable P2P without enough IO memory configured in BIOS.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># xbutil p2p --enable
ERROR: Not enough iomem space.
Please check BIOS settings
</pre></div>
</div>
</div>
<div class="section" id="disable-p2p">
<h3>Disable P2P<a class="headerlink" href="#disable-p2p" title="Permalink to this headline">¶</a></h3>
<p>Disable and re-enable P2P.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            true
...
# xbutil p2p --disable
# xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            false
...
# xbutil p2p --enable
# xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            true
...
</pre></div>
</div>
</div>
<div class="section" id="force-enable-disable">
<h3>Force Enable/Disable<a class="headerlink" href="#force-enable-disable" title="Permalink to this headline">¶</a></h3>
<p>This is for advanced user. Force enabling P2P is going to free and renumerate all devices under same root bus. The result of failed freeing of devices other than SDx platform is undefined. The best scenario is there is only SDx platform under the same root bus.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># xbutil p2p --enable -f
# xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            true
...
# xbutil p2p --disable
# xbutil query
...
PCIe            DMA chan(bidir) MIG Calibrated  P2P Enabled
GEN 3x16        2               true            false
...
</pre></div>
</div>
</div>
<div class="section" id="pcie-topology-considerations">
<h3>PCIe Topology Considerations<a class="headerlink" href="#pcie-topology-considerations" title="Permalink to this headline">¶</a></h3>
<p>For best performance peer devices wanting to exchange data should be under the same PCIe switch.</p>
<p>If IOMMU is enabled then all peer-to-peer transfers are routed through the root complex which will degrade performance significantly.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="m2m.html" class="btn btn-neutral float-right" title="Memory-to-Memory (M2M) Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="create_platforms.html" class="btn btn-neutral" title="Create MPSoC Based Embedded Platforms" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Xilinx, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2019.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>